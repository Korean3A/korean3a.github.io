<!DOCTYPE html>
<html lang="ko-KR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³µì‹ì¼ì • | ì„ë©´ì¶”ë°©êµ­ë¯¼ì—°ëŒ€</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="notion-styles.css">
  <link rel="shortcut icon" href="images/favicon.ico">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-66JZRCVRGE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-66JZRCVRGE');
  </script>
</head>

<body>
  <nav></nav>

  <!-- ë³¸ë¬¸ -->
  <main class="page-container" style="margin-top: 100px; padding-top: 20px;">
    <div class="schedule-header">
      <h1>ê³µì‹ì¼ì •</h1>
      <div class="schedule-controls">
        <span class="view-tag">ğŸ“… íƒ€ì„ë¼ì¸</span>
      </div>
    </div>

    <div id="schedule-timeline" class="schedule-timeline">
      <div class="spinner-wrap">
        <div class="spinner"></div>
        <p>ì¼ì •ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
      </div>
    </div>
  </main>

  <footer id="myFooter" class="k3a-footer"></footer>

  <script src="script.js"></script>
  <script src="notion-preview.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      includeHTML('nav.html', 'nav');
      includeHTML('footer.html', '#myFooter');
      initTimeline();
    });

    async function initTimeline() {
      const container = document.getElementById('schedule-timeline');
      try {
        const posts = await fetchNotionPosts('schedule');

        if (posts.length === 0) {
          container.innerHTML = '<p class="empty-message">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        // ê° í¬ìŠ¤íŠ¸ì˜ ë³¸ë¬¸ì„ í•¨ê»˜ ê°€ì ¸ì˜´
        const fullPosts = await Promise.all(posts.map(async (post) => {
          try {
            const res = await fetch(`/api/get-notion-content?pageId=${post.id}`);
            const data = await res.json();
            return { ...post, content: data };
          } catch (e) {
            return { ...post, content: null };
          }
        }));

        renderTimeline(fullPosts, container);
      } catch (error) {
        console.error('Timeline init error:', error);
        container.innerHTML = '<p class="error">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    function renderTimeline(posts, container) {
      container.innerHTML = posts.map(post => {
        const dateStr = post.scheduleDate ? formatDate(post.scheduleDate) : formatDate(post.createdTime);
        const { page, blocks } = post.content || {};

        // ì‘ì„±ì/ì•„ì´ì½˜ ì¶”ì¶œ
        const authorName = page?.properties['ì‘ì„±ì']?.rich_text?.[0]?.plain_text || 'ì„ë©´ì¶”ë°©êµ­ë¯¼ì—°ëŒ€';
        const authorIcon = post.coverUrl || 'images/logo_eng_cutted.png';

        return `
          <div class="schedule-card" id="post-${post.id}">
            <div class="card-header">
              <div class="author-avatar">
                <img src="${authorIcon}" alt="avatar" onerror="this.src='images/logo_eng_cutted.png'">
              </div>
              <div class="author-info">
                <span class="author-name">${escapeHtml(authorName)}</span>
                <span class="author-meta">${dateStr}</span>
              </div>
            </div>
            <div class="card-title">
              <span class="icon">ğŸš©</span>
              <span>${escapeHtml(post.title)}</span>
            </div>
            <div class="card-body">
              ${blocks ? renderBlocks(blocks) : '<p>ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>'}
            </div>
          </div>
        `;
      }).join('');

      // URLì— idê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì¹´ë“œë¡œ ìŠ¤í¬ë¡¤
      const urlParams = new URLSearchParams(window.location.search);
      const targetId = urlParams.get('id');
      if (targetId) {
        setTimeout(() => {
          const el = document.getElementById(`post-${targetId}`);
          if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 500);
      }
    }
  </script>
</body>

</html>
